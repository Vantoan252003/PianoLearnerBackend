<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Yêu thích - Admin</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        .stat-card {
            border-radius: 15px;
            padding: 1.5rem;
            color: white;
            border: none;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            transition: transform 0.3s;
        }
        .stat-card:hover { transform: translateY(-5px); }
        .stat-icon { font-size: 2.5rem; opacity: 0.8; }
        .stat-value { font-size: 2rem; font-weight: 700; margin: 0.5rem 0; }
        .stat-label { font-size: 0.9rem; opacity: 0.9; }
        .filter-section {
            background: #f8f9fa;
            padding: 1.5rem;
            border-radius: 10px;
            margin-bottom: 1.5rem;
        }
    </style>
</head>
<body>
    <th:block th:replace="~{admin/parts/navbar :: navbar}"></th:block>

    <div class="container-fluid mt-4">
        <div class="row">
            <div class="col-md-2">
                <th:block th:replace="~{admin/parts/sidebar :: sidebar('favorites')}"></th:block>
            </div>

            <div class="col-md-10">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h2><i class="bi bi-heart-fill"></i> Mục yêu thích</h2>
                </div>

                <!-- Statistics Cards -->
                <div class="row mb-4">
                    <div class="col-md-4">
                        <div class="stat-card" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                            <i class="bi bi-heart-fill stat-icon"></i>
                            <div class="stat-value" id="totalFavorites">0</div>
                            <div class="stat-label">Tổng Yêu thích</div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="stat-card" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">
                            <i class="bi bi-music-note-beamed stat-icon"></i>
                            <div class="stat-value" id="favoriteSongs">0</div>
                            <div class="stat-label">Bài hát</div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="stat-card" style="background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);">
                            <i class="bi bi-file-music-fill stat-icon"></i>
                            <div class="stat-value" id="favoriteSheets">0</div>
                            <div class="stat-label">Sheet Music</div>
                        </div>
                    </div>
                </div>

                <!-- Filters -->
                <div class="filter-section">
                    <div class="row g-3">
                        <div class="col-md-4">
                            <label class="form-label fw-bold">
                                <i class="bi bi-funnel"></i> Loại
                            </label>
                            <select class="form-select" id="filterType" onchange="applyFilters()">
                                <option value="">Tất cả</option>
                                <option value="song">Bài hát</option>
                                <option value="sheet">Sheet Music</option>
                            </select>
                        </div>
                        <div class="col-md-8">
                            <label class="form-label fw-bold">
                                <i class="bi bi-search"></i> Tìm kiếm
                            </label>
                            <input type="text" class="form-control" id="searchInput" 
                                   placeholder="Tìm theo tên người dùng..." 
                                   onkeyup="applyFilters()">
                        </div>
                    </div>
                </div>

                <!-- Table -->
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
                            <tr>
                                <th>Người dùng</th>
                                <th>Loại</th>
                                <th>Thông tin</th>
                                <th>Ngày thích</th>
                                <th>Thao tác</th>
                            </tr>
                        </thead>
                        <tbody id="tableBody"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const API_URL = '/api/admin/favorites';
        const token = localStorage.getItem('adminToken');
        let allFavorites = [];
        
        if(!token) window.location.href='/admin/login';

        async function loadData(){
            const res = await fetch(API_URL, { headers: { 'Authorization': `Bearer ${token}` }});
            allFavorites = await res.json();
            updateStatistics();
            applyFilters();
        }

        function updateStatistics() {
            document.getElementById('totalFavorites').textContent = allFavorites.length;
            
            const songCount = allFavorites.filter(f => f.song).length;
            document.getElementById('favoriteSongs').textContent = songCount;
            
            const sheetCount = allFavorites.filter(f => f.sheetMusic).length;
            document.getElementById('favoriteSheets').textContent = sheetCount;
        }

        function applyFilters() {
            const typeFilter = document.getElementById('filterType').value;
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();

            let filtered = allFavorites.filter(fav => {
                const matchesType = !typeFilter || 
                    (typeFilter === 'song' && fav.song) ||
                    (typeFilter === 'sheet' && fav.sheetMusic);
                const matchesSearch = !searchTerm || 
                    (fav.user?.fullName || '').toLowerCase().includes(searchTerm);
                return matchesType && matchesSearch;
            });

            renderTable(filtered);
        }

        function renderTable(data) {
            const tbody = document.getElementById('tableBody');
            tbody.innerHTML='';
            data.forEach(f => {
                let itemType = '-';
                let itemReference = '-';
                
                if (f.song) {
                    itemType = '<span class="badge bg-primary"><i class="bi bi-music-note-beamed"></i> Bài hát</span>';
                    itemReference = `<strong>${f.song.songTitle}</strong><br><small class="text-muted">Nghệ sĩ: ${f.song.artist || 'N/A'}</small>`;
                } else if (f.sheetMusic) {
                    itemType = '<span class="badge bg-success"><i class="bi bi-file-music"></i> Sheet nhạc</span>';
                    itemReference = `<strong>${f.sheetMusic.title}</strong><br><small class="text-muted">Nhạc sĩ: ${f.sheetMusic.composer || 'N/A'}</small>`;
                }
                
                const addedAt = f.addedAt ? new Date(f.addedAt).toLocaleString('vi-VN') : '-';
                
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>
                        <strong>${f.user ? f.user.fullName : '-'}</strong>
                        <br><small class="text-muted">${f.user ? f.user.email : ''}</small>
                    </td>
                    <td>${itemType}</td>
                    <td>${itemReference}</td>
                    <td><small>${addedAt}</small></td>
                    <td><button class='btn btn-sm btn-danger' onclick='deleteData(${f.favoriteId})' title='Xóa'><i class='bi bi-trash'></i></button></td>
                `;
                tbody.appendChild(tr);
            });
        }

        async function deleteData(id){
            if(!confirm('Xóa bản ghi này?')) return;
            const res = await fetch(`${API_URL}/${id}`, { method:'DELETE', headers: { 'Authorization': `Bearer ${token}` }});
            if(res.ok){ alert('Đã xóa!'); loadData(); } else { alert('Lỗi khi xóa!'); }
        }

        loadData();
    </script>
</body>
</html>


