<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <title>Quản lý Câu hỏi Piano - Admin</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
  <style>
    .stat-card {
      border-radius: 15px;
      padding: 1.5rem;
      color: white;
      border: none;
      box-shadow: 0 4px 15px rgba(0,0,0,0.1);
      transition: transform 0.3s;
    }
    .stat-card:hover { transform: translateY(-5px); }
    .stat-icon { font-size: 2.5rem; opacity: 0.8; }
    .stat-value { font-size: 2rem; font-weight: 700; margin: 0.5rem 0; }
    .stat-label { font-size: 0.9rem; opacity: 0.9; }
    .filter-section {
      background: #f8f9fa;
      padding: 1.5rem;
      border-radius: 10px;
      margin-bottom: 1.5rem;
    }
    .midi-note {
      display: inline-block;
      padding: 4px 10px;
      margin: 2px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border-radius: 15px;
      font-size: 0.85rem;
      font-weight: 600;
    }
    .chord-badge {
      display: inline-block;
      padding: 5px 12px;
      margin: 2px;
      background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
      color: #333;
      border-radius: 15px;
      font-size: 0.9rem;
      font-weight: 600;
    }
  </style>
</head>
<body>
  <th:block th:replace="~{admin/parts/navbar :: navbar}"></th:block>

  <div class="container-fluid mt-4">
    <div class="row">
      <div class="col-md-2">
        <th:block th:replace="~{admin/parts/sidebar :: sidebar('piano-questions')}"></th:block>
      </div>

      <div class="col-md-10">
        <div class="d-flex justify-content-between align-items-center mb-4">
          <h2><i class="bi bi-question-circle-fill"></i> Quản lý Câu hỏi Piano</h2>
          <button class="btn btn-primary" onclick="openAddModal()">
            <i class="bi bi-plus-circle"></i> Thêm câu hỏi
          </button>
        </div>

        <!-- Statistics Cards -->
        <div class="row mb-4">
          <div class="col-md-3">
            <div class="stat-card" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
              <i class="bi bi-question-circle stat-icon"></i>
              <div class="stat-value" id="totalQuestions">0</div>
              <div class="stat-label">Tổng Câu hỏi</div>
            </div>
          </div>
          <div class="col-md-3">
            <div class="stat-card" style="background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);">
              <i class="bi bi-star-fill stat-icon"></i>
              <div class="stat-value" id="beginnerCount">0</div>
              <div class="stat-label">Beginner</div>
            </div>
          </div>
          <div class="col-md-3">
            <div class="stat-card" style="background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);">
              <i class="bi bi-star-half stat-icon"></i>
              <div class="stat-value" id="intermediateCount">0</div>
              <div class="stat-label">Intermediate</div>
            </div>
          </div>
          <div class="col-md-3">
            <div class="stat-card" style="background: linear-gradient(135deg, #ff6a00 0%, #ee0979 100%);">
              <i class="bi bi-rocket-takeoff-fill stat-icon"></i>
              <div class="stat-value" id="advancedCount">0</div>
              <div class="stat-label">Advanced</div>
            </div>
          </div>
        </div>

        <!-- Filters -->
        <div class="filter-section">
          <div class="row g-3">
            <div class="col-md-3">
              <label class="form-label fw-bold">
                <i class="bi bi-funnel"></i> Độ khó
              </label>
              <select class="form-select" id="filterDifficulty" onchange="applyFilters()">
                <option value="">Tất cả</option>
                <option value="Beginner">Beginner</option>
                <option value="Intermediate">Intermediate</option>
                <option value="Advanced">Advanced</option>
              </select>
            </div>
            <div class="col-md-3">
              <label class="form-label fw-bold">
                <i class="bi bi-book"></i> Bài học
              </label>
              <select class="form-select" id="filterLesson" onchange="applyFilters()">
                <option value="">Tất cả</option>
              </select>
            </div>
            <div class="col-md-6">
              <label class="form-label fw-bold">
                <i class="bi bi-search"></i> Tìm kiếm
              </label>
              <input type="text" class="form-control" id="searchInput" 
                     placeholder="Tìm theo MIDI hoặc Chord..." 
                     onkeyup="applyFilters()">
            </div>
          </div>
        </div>

        <!-- Table -->
        <div class="table-responsive">
          <table class="table table-hover">
            <thead style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
              <tr>
                <th>ID</th>
                <th>MIDI Notes</th>
                <th>Chords</th>
                <th>Số câu</th>
                <th>Độ khó</th>
                <th>Bài học</th>
                <th>Thao tác</th>
              </tr>
            </thead>
            <tbody id="tableBody"></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal -->
  <div class="modal fade" id="dataModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="modalTitle">Thêm câu hỏi</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body" style="max-height: 600px; overflow-y: auto;">
          <form id="dataForm">
            <input type="hidden" id="questionId">
            <div class="mb-3">
              <label class="form-label">Bài học <span class="text-danger">*</span></label>
              <select id="lessonId" class="form-select" required></select>
            </div>
            <div class="mb-3">
              <label class="form-label">MIDI Numbers (Nốt nhạc) <span class="text-danger">*</span></label>
              <div id="midiCheckboxes" class="border p-3 rounded" style="max-height: 200px; overflow-y: auto;">
                <!-- Checkboxes will be generated here -->
              </div>
            </div>
            <div class="mb-3">
              <label class="form-label">Chord (Hợp âm)</label>
              <div id="chordSection">
                <div id="chordList"></div>
                <button type="button" class="btn btn-sm btn-success mt-2" onclick="addChord()">+ Thêm hợp âm</button>
              </div>
            </div>
            <div class="mb-3">
              <label class="form-label">Question Count</label>
              <input type="number" id="questionCount" class="form-control" placeholder="0" min="0">
            </div>
            <div class="mb-3">
              <label class="form-label">Độ khó</label>
              <select id="difficulty" class="form-select">
                <option value="Beginner">Beginner</option>
                <option value="Intermediate">Intermediate</option>
                <option value="Advanced">Advanced</option>
              </select>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
          <button class="btn btn-primary" onclick="saveData()">Lưu</button>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script th:inline="none">
    const API_URL = '/api/admin/piano-questions';
    const token = localStorage.getItem('adminToken');
    let editMode = false;
    let allQuestions = [];
    let lessons = [];

    
    // MIDI note mapping
    const MIDI_NOTES = [
      { midi: 60, name: 'C4', octave: 4 },
      { midi: 61, name: 'C#4', octave: 4 },
      { midi: 62, name: 'D4', octave: 4 },
      { midi: 63, name: 'D#4', octave: 4 },
      { midi: 64, name: 'E4', octave: 4 },
      { midi: 65, name: 'F4', octave: 4 },
      { midi: 66, name: 'F#4', octave: 4 },
      { midi: 67, name: 'G4', octave: 4 },
      { midi: 68, name: 'G#4', octave: 4 },
      { midi: 69, name: 'A4', octave: 4 },
      { midi: 70, name: 'A#4', octave: 4 },
      { midi: 71, name: 'B4', octave: 4 },
      { midi: 72, name: 'C5', octave: 5 },
      { midi: 73, name: 'C#5', octave: 5 },
      { midi: 74, name: 'D5', octave: 5 },
      { midi: 75, name: 'D#5', octave: 5 },
      { midi: 76, name: 'E5', octave: 5 },
      { midi: 77, name: 'F5', octave: 5 },
      { midi: 78, name: 'F#5', octave: 5 },
      { midi: 79, name: 'G5', octave: 5 },
      { midi: 80, name: 'G#5', octave: 5 },
      { midi: 81, name: 'A5', octave: 5 },
      { midi: 82, name: 'A#5', octave: 5 },
      { midi: 83, name: 'B5', octave: 5 }
    ];

    if (!token) window.location.href = '/admin/login';

    function initMidiCheckboxes() {
      const container = document.getElementById('midiCheckboxes');
      container.innerHTML = '';
      MIDI_NOTES.forEach(note => {
        const div = document.createElement('div');
        div.className = 'form-check form-check-inline';
        div.innerHTML = `
          <input class="form-check-input midi-checkbox" type="checkbox" id="midi_${note.midi}" value="${note.midi}">
          <label class="form-check-label" for="midi_${note.midi}">${note.name}</label>
        `;
        container.appendChild(div);
      });
    }

    function addChord() {
      const chordList = document.getElementById('chordList');
      const chordId = 'chord_' + Date.now();
      const div = document.createElement('div');
      div.className = 'chord-item mb-3 p-2 border rounded';
      div.id = chordId;
      div.innerHTML = `
        <div class="d-flex justify-content-between align-items-center mb-2">
          <label class="form-label mb-0">Hợp âm #${chordList.children.length + 1}</label>
          <button type="button" class="btn btn-sm btn-danger" onclick="removeChord('${chordId}')">Xóa</button>
        </div>
        <div class="chord-checkboxes" style="max-height: 150px; overflow-y: auto; border: 1px solid #ddd; padding: 8px; border-radius: 4px;">
          <!-- Checkboxes will be generated here -->
        </div>
      `;
      chordList.appendChild(div);
      
      const checkboxContainer = div.querySelector('.chord-checkboxes');
      MIDI_NOTES.forEach(note => {
        const checkDiv = document.createElement('div');
        checkDiv.className = 'form-check form-check-inline';
        checkDiv.innerHTML = `
          <input class="form-check-input chord-checkbox" type="checkbox" id="${chordId}_midi_${note.midi}" value="${note.midi}" data-chord-id="${chordId}">
          <label class="form-check-label" for="${chordId}_midi_${note.midi}">${note.name}</label>
        `;
        checkboxContainer.appendChild(checkDiv);
      });
    }

    function removeChord(chordId) {
      document.getElementById(chordId).remove();
    }

    async function loadLessons() {
      try {
        const res = await fetch('/api/admin/lessons', { headers: { 'Authorization': `Bearer ${token}` }});
        lessons = await res.json();
        const select = document.getElementById('lessonId');
        select.innerHTML = '<option value="">-- Chọn bài học --</option>';
        lessons.forEach(l => {
          select.innerHTML += `<option value="${l.lessonId}">${l.lessonTitle}</option>`;
        });
        populateLessonFilter();
      } catch (e) {
        console.error('Error loading lessons', e);
      }
    }

    async function loadData() {
      const res = await fetch(API_URL, { headers: { 'Authorization': `Bearer ${token}` }});
      allQuestions = await res.json();
      updateStatistics();
      populateLessonFilter();
      applyFilters();
    }

    function updateStatistics() {
      document.getElementById('totalQuestions').textContent = allQuestions.length;
      
      const beginner = allQuestions.filter(q => q.difficulty === 'Beginner').length;
      document.getElementById('beginnerCount').textContent = beginner;
      
      const intermediate = allQuestions.filter(q => q.difficulty === 'Intermediate').length;
      document.getElementById('intermediateCount').textContent = intermediate;
      
      const advanced = allQuestions.filter(q => q.difficulty === 'Advanced').length;
      document.getElementById('advancedCount').textContent = advanced;
    }

    function populateLessonFilter() {
      const filter = document.getElementById('filterLesson');
      const lessonIds = [...new Set(allQuestions.map(q => q.lesson?.lessonId).filter(id => id))];
      filter.innerHTML = '<option value="">Tất cả</option>';
      lessonIds.forEach(id => {
        const lesson = lessons.find(l => l.lessonId === id);
        if (lesson) {
          filter.innerHTML += `<option value="${id}">${lesson.lessonTitle}</option>`;
        }
      });
    }

    function applyFilters() {
      const difficultyFilter = document.getElementById('filterDifficulty').value;
      const lessonFilter = document.getElementById('filterLesson').value;
      const searchTerm = document.getElementById('searchInput').value.toLowerCase();

      let filtered = allQuestions.filter(q => {
        const matchesDifficulty = !difficultyFilter || q.difficulty === difficultyFilter;
        const matchesLesson = !lessonFilter || q.lesson?.lessonId == lessonFilter;
        
        let matchesSearch = true;
        if (searchTerm) {
          const midiStr = JSON.stringify(q.midiNumbers || []).toLowerCase();
          const chordStr = JSON.stringify(q.chord || []).toLowerCase();
          matchesSearch = midiStr.includes(searchTerm) || chordStr.includes(searchTerm);
        }
        
        return matchesDifficulty && matchesLesson && matchesSearch;
      });

      renderTable(filtered);
    }

    function midiToNoteName(midi) {
      const note = MIDI_NOTES.find(n => n.midi === parseInt(midi));
      return note ? note.name : midi;
    }

    function renderTable(data) {
      const tbody = document.getElementById('tableBody');
      tbody.innerHTML = '';
      data.forEach(q => {
        let midiStr = '';
        try {
          const midiArr = Array.isArray(q.midiNumbers) 
            ? q.midiNumbers 
            : JSON.parse(q.midiNumbers || '[]');
          midiStr = midiArr.map(m => `<span class="midi-note">${midiToNoteName(m)}</span>`).join(' ');
        } catch (e) {
          midiStr = '<span class="badge bg-secondary">Invalid</span>';
        }
        
        let chordStr = '';
        try {
          const chordArr = Array.isArray(q.chord) 
            ? q.chord 
            : JSON.parse(q.chord || '[]');
          chordStr = chordArr.map(chord => 
            '<span class="chord-badge">' + chord.map(m => midiToNoteName(m)).join('-') + '</span>'
          ).join(' ');
        } catch (e) {
          chordStr = '<span class="badge bg-secondary">Invalid</span>';
        }
        
        const difficultyColor = {
          'Beginner': 'success',
          'Intermediate': 'warning',
          'Advanced': 'danger'
        }[q.difficulty] || 'secondary';
        
        const tr = document.createElement('tr');
        tr.innerHTML = 
          '<td>' + q.questionId + '</td>' +
          '<td>' + midiStr + '</td>' +
          '<td>' + chordStr + '</td>' +
          '<td><span class="badge bg-primary">' + (q.questionCount || 0) + '</span></td>' +
          '<td><span class="badge bg-' + difficultyColor + '">' + q.difficulty + '</span></td>' +
          '<td>' + (q.lesson ? '<span class="badge bg-info">' + q.lesson.lessonTitle + '</span>' : '-') + '</td>' +
          '<td>' +
            '<button class="btn btn-sm btn-warning" onclick="editData(' + q.questionId + ')" title="Sửa"><i class="bi bi-pencil"></i></button> ' +
            '<button class="btn btn-sm btn-danger" onclick="deleteData(' + q.questionId + ')" title="Xóa"><i class="bi bi-trash"></i></button>' +
          '</td>';
        tbody.appendChild(tr);
      });
    }

    function openAddModal() {
      editMode = false;
      document.getElementById('dataForm').reset();
      document.getElementById('chordList').innerHTML = '';
      initMidiCheckboxes();
      document.querySelectorAll('.midi-checkbox').forEach(cb => cb.checked = false);
      new bootstrap.Modal(document.getElementById('dataModal')).show();
    }

    async function editData(id) {
      editMode = true;
      const res = await fetch(`${API_URL}/${id}`, { headers: { 'Authorization': `Bearer ${token}` }});
      const q = await res.json();
      console.log('editData - loaded question:', q);
      console.log('lesson object:', q.lesson);
      document.getElementById('questionId').value = q.questionId;
      document.getElementById('lessonId').value = q.lesson ? String(q.lesson.lessonId) : '';
      console.log('set lessonId to:', document.getElementById('lessonId').value);
      
      // Initialize checkboxes first
      initMidiCheckboxes();
      document.getElementById('chordList').innerHTML = '';
      
      // Set MIDI checkboxes
      let midiNums = [];
      try {
        midiNums = Array.isArray(q.midiNumbers) ? q.midiNumbers : JSON.parse(q.midiNumbers || '[]');
      } catch (e) {
        midiNums = [];
      }
      midiNums.forEach(midi => {
        const checkbox = document.getElementById('midi_' + midi);
        if (checkbox) checkbox.checked = true;
      });
      
      // Set chord checkboxes
      let chords = [];
      try {
        chords = Array.isArray(q.chord) ? q.chord : JSON.parse(q.chord || '[]');
      } catch (e) {
        chords = [];
      }
      chords.forEach(chordNotes => {
        const chordDiv = document.createElement('div');
        const chordId = 'chord_' + Date.now() + Math.random();
        chordDiv.className = 'chord-item mb-3 p-2 border rounded';
        chordDiv.id = chordId;
        let checkboxesHtml = `
          <div class="d-flex justify-content-between align-items-center mb-2">
            <label class="form-label mb-0">Hợp âm</label>
            <button type="button" class="btn btn-sm btn-danger" onclick="removeChord('${chordId}')">Xóa</button>
          </div>
          <div class="chord-checkboxes" style="max-height: 150px; overflow-y: auto; border: 1px solid #ddd; padding: 8px; border-radius: 4px;">
        `;
        MIDI_NOTES.forEach(note => {
          checkboxesHtml += `
            <div class="form-check form-check-inline">
              <input class="form-check-input chord-checkbox" type="checkbox" id="${chordId}_midi_${note.midi}" value="${note.midi}" data-chord-id="${chordId}" ${chordNotes.includes(note.midi) ? 'checked' : ''}>
              <label class="form-check-label" for="${chordId}_midi_${note.midi}">${note.name}</label>
            </div>
          `;
        });
        checkboxesHtml += '</div>';
        chordDiv.innerHTML = checkboxesHtml;
        document.getElementById('chordList').appendChild(chordDiv);
      });
      
      document.getElementById('questionCount').value = q.questionCount || 0;
      document.getElementById('difficulty').value = q.difficulty;
      new bootstrap.Modal(document.getElementById('dataModal')).show();
    }

    async function saveData() {
      const lessonIdValue = document.getElementById('lessonId').value;
      console.log('lessonIdValue:', lessonIdValue);
      if (!lessonIdValue) {
        alert('Vui lòng chọn bài học!');
        return;
      }
      
      // Get selected MIDI numbers from checkboxes
      const selectedMidis = Array.from(document.querySelectorAll('.midi-checkbox:checked')).map(cb => parseInt(cb.value));
      console.log('selectedMidis:', selectedMidis);
      if (selectedMidis.length === 0) {
        alert('Vui lòng chọn ít nhất một nốt nhạc!');
        return;
      }
      
      // Get chord notes
      const chordItems = document.querySelectorAll('.chord-item');
      const chords = [];
      chordItems.forEach(chordItem => {
        const selectedNotes = Array.from(chordItem.querySelectorAll('.chord-checkbox:checked')).map(cb => parseInt(cb.value));
        if (selectedNotes.length > 0) {
          chords.push(selectedNotes);
        }
      });
      console.log('chords:', chords);
      
      const questionCountValue = document.getElementById('questionCount').value;
      const difficultyValue = document.getElementById('difficulty').value;
      console.log('questionCount:', questionCountValue, 'difficulty:', difficultyValue);

      const id = document.getElementById('questionId').value;
      console.log('id:', id, 'editMode:', editMode);
      const data = {
        lessonId: parseInt(lessonIdValue),
        midiNumbers: selectedMidis,
        chord: chords,
        questionCount: parseInt(questionCountValue) || 0,
        difficulty: difficultyValue
      };
      console.log('data to send:', data);

      const method = editMode ? 'PUT' : 'POST';
      const url = editMode ? `${API_URL}/${id}` : API_URL;
      console.log('method:', method, 'url:', url);

      const res = await fetch(url, {
        method: method,
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${token}`
        },
        body: JSON.stringify(data)
      });
      console.log('response status:', res.status, 'ok:', res.ok);

      if (res.ok) {
        alert('Lưu thành công!');
        bootstrap.Modal.getInstance(document.getElementById('dataModal')).hide();
        loadData();
      } else {
        const errorText = await res.text();
        console.log('error response:', errorText);
        alert('Lỗi khi lưu: ' + errorText);
      }
    }

    async function deleteData(id) {
      if (!confirm('Xóa câu hỏi này?')) return;
      const res = await fetch(`${API_URL}/${id}`, {
        method: 'DELETE',
        headers: { 'Authorization': `Bearer ${token}` }
      });
      if (res.ok) {
        alert('Đã xóa!');
        loadData();
      } else {
        alert('Lỗi khi xóa!');
      }
    }

    loadLessons();
    loadData();
  </script>
</body>
</html>
