<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <title>Quản lý Câu hỏi Piano - Admin</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
  
</head>
<body>
  <th:block th:replace="~{admin/parts/navbar :: navbar}"></th:block>

  <div class="container-fluid mt-4">
    <div class="row">
      <div class="col-md-2">
        <th:block th:replace="~{admin/parts/sidebar :: sidebar('piano-questions')}"></th:block>
      </div>

      <div class="col-md-10">
        <div class="d-flex justify-content-between align-items-center mb-3">
          <h2>Quản lý Câu hỏi Piano</h2>
          <button class="btn btn-primary" onclick="openAddModal()"><i class="bi bi-plus-circle"></i> Thêm câu hỏi</button>
        </div>

        <div class="table-responsive">
          <table class="table table-striped table-hover">
            <thead class="table-dark">
              <tr>
                <th>ID</th>
                <th>MIDI</th>
                <th>Độ khó</th>
                <th>Bài học</th>
                <th>Ngày tạo</th>
                <th>Thao tác</th>
              </tr>
            </thead>
            <tbody id="tableBody"></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal -->
  <div class="modal fade" id="dataModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="modalTitle">Thêm câu hỏi</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <form id="dataForm">
            <input type="hidden" id="questionId">
            <div class="mb-3">
              <label class="form-label">Bài học <span class="text-danger">*</span></label>
              <select id="lessonId" class="form-select" required></select>
            </div>
            <div class="mb-3">
  <label class="form-label">MIDI Numbers</label>
  <input type="text" id="midiNumbers" class="form-control" placeholder="Ví dụ: 40,43,47,52" required>
</div>

            <div class="mb-3">
              <label class="form-label">Độ khó</label>
              <select id="difficulty" class="form-select">
                <option value="Beginner">Beginner</option>
                <option value="Intermediate">Intermediate</option>
                <option value="Advanced">Advanced</option>
              </select>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
          <button class="btn btn-primary" onclick="saveData()">Lưu</button>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    const API_URL = '/api/admin/piano-questions';
    const token = localStorage.getItem('adminToken');
    let editMode = false;
    let lessons = [];

    if (!token) window.location.href = '/admin/login';

    async function loadLessons() {
      try {
        const res = await fetch('/api/admin/lessons', { headers: { 'Authorization': `Bearer ${token}` }});
        lessons = await res.json();
        const select = document.getElementById('lessonId');
        select.innerHTML = '<option value="">-- Chọn bài học --</option>';
        lessons.forEach(l => {
          select.innerHTML += `<option value="${l.lessonId}">${l.lessonTitle}</option>`;
        });
      } catch (e) {
        console.error('Error loading lessons', e);
      }
    }

    async function loadData() {
      const res = await fetch(API_URL, { headers: { 'Authorization': `Bearer ${token}` }});
      const data = await res.json();
      renderTable(data);
    }

    function renderTable(data) {
      const tbody = document.getElementById('tableBody');
      tbody.innerHTML = '';
      data.forEach(q => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${q.questionId}</td>
          <td>${Array.isArray(q.midiNumbers) 
      ? q.midiNumbers.join(', ') 
      : JSON.parse(q.midiNumbers || '[]').join(', ')}</td>

          <td><span class="badge bg-info">${q.difficulty}</span></td>
          <td>${q.lesson ? q.lesson.lessonTitle : '-'}</td>
          <td>${q.createdAt ? new Date(q.createdAt).toLocaleString('vi-VN') : '-'}</td>
          <td>
            <button class="btn btn-sm btn-warning" onclick="editData(${q.questionId})"><i class="bi bi-pencil"></i></button>
            <button class="btn btn-sm btn-danger" onclick="deleteData(${q.questionId})"><i class="bi bi-trash"></i></button>
          </td>
        `;
        tbody.appendChild(tr);
      });
    }

    function openAddModal() {
      editMode = false;
      document.getElementById('dataForm').reset();
      new bootstrap.Modal(document.getElementById('dataModal')).show();
    }

    async function editData(id) {
      editMode = true;
      const res = await fetch(`${API_URL}/${id}`, { headers: { 'Authorization': `Bearer ${token}` }});
      const q = await res.json();
      document.getElementById('questionId').value = q.questionId;
      document.getElementById('lessonId').value = q.lesson ? q.lesson.lessonId : '';
    const nums = Array.isArray(q.midiNumbers)
      ? q.midiNumbers
      : JSON.parse(q.midiNumbers || '[]');
    document.getElementById('midiNumbers').value = nums.join(', ');
      document.getElementById('difficulty').value = q.difficulty;
      new bootstrap.Modal(document.getElementById('dataModal')).show();
    }

    async function saveData() {
      const id = document.getElementById('questionId').value;
      const data = {
        lessonId: parseInt(document.getElementById('lessonId').value),
        midiNumbers: document.getElementById('midiNumbers').value
  .split(',')
  .map(n => parseInt(n.trim()))
  .filter(n => !isNaN(n)),
        difficulty: document.getElementById('difficulty').value
      };

      const method = editMode ? 'PUT' : 'POST';
      const url = editMode ? `${API_URL}/${id}` : API_URL;

      const res = await fetch(url, {
        method: method,
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${token}`
        },
        body: JSON.stringify(data)
      });

      if (res.ok) {
        alert('Lưu thành công!');
        bootstrap.Modal.getInstance(document.getElementById('dataModal')).hide();
        loadData();
      } else {
        alert('Lỗi khi lưu!');
      }
    }

    async function deleteData(id) {
      if (!confirm('Xóa câu hỏi này?')) return;
      const res = await fetch(`${API_URL}/${id}`, {
        method: 'DELETE',
        headers: { 'Authorization': `Bearer ${token}` }
      });
      if (res.ok) {
        alert('Đã xóa!');
        loadData();
      } else {
        alert('Lỗi khi xóa!');
      }
    }

    loadLessons();
    loadData();
  </script>
</body>
</html>
